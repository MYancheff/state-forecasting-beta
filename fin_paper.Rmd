---
title: "fin_paper"
output: github_document
---

```{r}
library(foreign)
library(tidyverse)
library(lubridate)
library(rpart)
library(ggthemes)

source("load_carls.R")
source("load_precinct_data.R")
source("load_econ_data.R")


```

```{r district_level_data}
pres_summary = prec_data_election %>% 
  mutate(SENATE_OR_HOUSE=ifelse(SENATE_OR_HOUSE==8,"HOUSE","SENATE")) %>%
  group_by(officename,Year,SENATE_OR_HOUSE,DIST_NAME,DISTRICT_NUM,Selection) %>%
  summarise(vote_count = sum(Votes),
            Party = get_pres_gov_party(Selection[1])) %>%
  summarise(vote_dem = sum(ifelse(Party=="DEM",vote_count,0)),
            total_vote = sum(vote_count)) %>%
  ungroup() %>%
  gather(key=value_type,value=vote_value,vote_dem:total_vote)%>%
  unite(RaceValue,officename,value_type) %>%
  spread(RaceValue,vote_value)

named_data = use_data %>%
  left_join(filter(pres_summary,!is.na(DIST_NAME) & DIST_NAME!=""),
            by=c("ELECTION_YEAR"="Year","Assembly"="SENATE_OR_HOUSE","DISTRICT_NUM"="DISTRICT_NUM","DISTRICT_NAME"="DIST_NAME"))

unnamed_data = use_data %>%
  left_join(filter(pres_summary,is.na(DIST_NAME) | DIST_NAME==""),
            by=c("ELECTION_YEAR"="Year","Assembly"="SENATE_OR_HOUSE","DISTRICT_NUM"="DISTRICT_NUM")) %>%
  select(-DIST_NAME)

district_level_data = rbind(unnamed_data,named_data) %>%
  mutate(party_val = ifelse(wining_party == "DEM",1,
                            ifelse(wining_party == "REP",-1,0)),
         governor_perc_vote_dem = governor_vote_dem/governor_total_vote,
         president_perc_vote_dem = president_vote_dem/president_total_vote) %>%
  select(-(governor_total_vote:president_vote_dem))
```

The format of the tidied dataset we want to model is this:

Every row is a (Year, Assembly, District) triple. This is a nice unit because it is the unit we want to run models on. However, none of our data is in this form. All of our data is in a (Year, Canidate) format. So in each dataset, before joining, we need to summarise the sort of covariates we want from that bit of canidate level data.

```{r state_level_data}
pres_party_in_power_data = read_csv("state-legislative-data/pres_in_power.csv")

state_level_data = economic_data %>%
  left_join(pres_party_in_power_data,by=c("YEAR"="year")) %>%
  
  # spread party_in_power variable over all the years they are in power, not just every 4 years
  group_by((YEAR-1) %/% 4) %>%
  mutate(pres_party_in_power = paste(ifelse(is.na(pres_party_in_power),"",pres_party_in_power),collapse="")) %>%
  ungroup() %>%
  
  #calculate midterm and presidentail election penalties
  mutate(is_midterm = (YEAR %% 4) == 2,
         is_pres_election = (YEAR %% 4) == 0,
         pres_party_num = ifelse(pres_party_in_power=="DEM",1,
                                 ifelse(pres_party_in_power=="REP",-1,0)),
         midterm_penalty = pres_party_num * is_midterm,
         pres_elect_penalty = pres_party_num * is_pres_election) %>%
  
  select(YEAR:Unemployment_LOCAL,midterm_penalty,pres_elect_penalty)
```

```{r assembly_level_summary}
year_summary = district_level_data %>%
  group_by(Assembly,ELECTION_YEAR) %>%
  summarise(assembly_composition = sum(party_val)/n())%>%
  arrange(ELECTION_YEAR) %>%
  #lagged by one year entry (i.e. 2 years)
  mutate(lagged_assembly_composition = lag(assembly_composition)) %>%
  ungroup()
```

```{r}
joined_district_data = district_level_data %>%
  left_join(year_summary ,by=c("ELECTION_YEAR","Assembly")) %>%
  left_join(state_level_data ,by=c("ELECTION_YEAR"="YEAR")) %>%
  mutate(DIST_ID = factor(paste(DISTRICT_NAME,DISTRICT_NUM))) %>%
  select(-DISTRICT_NUM,-DISTRICT_NAME)
```

```{r impute_missing}
impute_mean = function(vector){
  vector[is.na(vector)] <- mean(vector, na.rm = T)
  vector
}
joined_district_data$governor_perc_vote_dem = impute_mean(joined_district_data$governor_perc_vote_dem)
joined_district_data$president_perc_vote_dem = impute_mean(joined_district_data$president_perc_vote_dem)
```

```{r}
testyear = 2010

single_level_model_data = joined_district_data %>%
  filter(ELECTION_YEAR >= 2004) # we don't have district numbers for 1968 and 1970! (this should be fixable)

all_train_data = single_level_model_data %>%
  filter(ELECTION_YEAR < testyear)

all_test_data =  single_level_model_data %>%
  filter(ELECTION_YEAR == testyear)

house_train_data = filter(all_train_data,Assembly=="HOUSE")
senate_train_data = filter(all_train_data,Assembly=="SENATE")

house_test_data = filter(all_test_data,Assembly=="HOUSE")
senate_test_data = filter(all_test_data,Assembly=="SENATE")

train_data = senate_train_data
model_single_level = function(train_data){
  lm(assembly_composition - lagged_assembly_composition ~ 
       MHI_Change_LOCAL +
       GDPperCapita_CHANGE_US + 
       incumbent_factor+
       governor_perc_vote_dem + 
       president_perc_vote_dem
       ,data=train_data)
}
model1 = model_single_level(senate_train_data)
AIC(model1)
guessed_outcome = predict(model1,senate_test_data)
actual_outcome = senate_test_data$assembly_composition - senate_test_data$lagged_assembly_composition
error = sqrt(sum((guessed_outcome-actual_outcome)^2)/nrow(senate_test_data))
error
```

Plot showing why we did Nevada.

```{r}
zero_intercept_years = year_summary %>%
  arrange(ELECTION_YEAR) %>%
  group_by(Assembly) %>%
  mutate(m = (assembly_composition-lag(assembly_composition))/(ELECTION_YEAR-lag(ELECTION_YEAR)),
         b = assembly_composition - m * ELECTION_YEAR,
         x_cross = -b/m) %>%
  filter(x_cross > lag(ELECTION_YEAR) & x_cross < ELECTION_YEAR) %>%
  ungroup() %>%
  mutate(ELECTION_YEAR=x_cross,
         assembly_composition=0) %>%
  select(ELECTION_YEAR,assembly_composition,Assembly)

plot_chart_use_data = year_summary %>%
  select(-lagged_assembly_composition) %>%
  rbind(zero_intercept_years) %>%
  arrange(ELECTION_YEAR)

argvar = data.frame(YEAR=c(min(plot_chart_use_data$ELECTION_YEAR),max(plot_chart_use_data$ELECTION_YEAR)),party_composition=c(0.5,0.5))

plot_chart_use_data %>%
  mutate(assembly_composition = assembly_composition*0.5 + 0.5,
         dem_years = assembly_composition,
         rep_years = 1-assembly_composition) %>%
  gather(dem_years,rep_years,key=party_year,value=party_composition) %>%
  ggplot(aes(x=ELECTION_YEAR,y=party_composition,fill=party_year)) + 
    geom_area(position="stack") + 
    facet_grid(~Assembly) + 
    geom_line(data=argvar,mapping=aes(x=YEAR,y=party_composition,fill=NA),color="black") + 
    theme_few() + 
    xlab("Year") + 
    ylab("Party control of assembly") + 
    ggtitle("Nevada State Legislature Party Composition over Time") + 
    scale_fill_manual(values=c("blue","red"),
                      labels=c("Democratic","Republican"),
                      guide = guide_legend(title = "Party"))
    
```

```{r}
#Calculate percentage of house captured by Democrats during a Given Year's General Election
percent_seat_data <- tot_data %>%
  group_by(ELECTION_YEAR, Assembly) %>%
  summarize(perc_seats_dem = sum(wining_party=="DEM")/n()) %>%
  left_join(economic_data,by=c("ELECTION_YEAR"="YEAR"))


#Tidy df so that we can graph data on a 2 dimensional plane 
#Exclude unemployment rate (it stretches te y-axis scale too far to capture insights on
# the correlating patterns between voting and economic data)
with_economic_Tidied1 <- percent_seat_data %>% gather(Type,Val,-ELECTION_YEAR, -Assembly, 
                                                      -Unemployment_LOCAL)
#Visualize 
graph1 <- ggplot(with_economic_Tidied1,aes(x=ELECTION_YEAR, y=Val, col=Type)) + 
  geom_line() + 
  facet_wrap(~Assembly)

#Tidy a separate df by gathering just Unemployment_Local  and perc_seats_dem under Type
with_economic_Tidied2 <- percent_seat_data %>% gather(key = Type, value = Percent, 
                                                      Unemployment_LOCAL, perc_seats_dem)
```

Why did we do what we did?
What did we do?

Code outcome data for 2016.
Figure out how to deal with redistricting.
Figure out how to deal with multi-member districts.



Visualizations???
Map with Clark county (maybe Carson city) zoomed out.
Line graph with color filled in. 

Model visualizations:



Precinct data:
Codebook.
Merging data together.
Precincts don't vote for every election every year. The way I figured out how to figure out senate district does not work.




Road citation:

Gary King; Bradley Palmquist; Greg Adams; Micah Altman;
Kenneth Benoit; Claudine Gay; Jeffrey B. Lewis; Russ Mayer;
and Eric Reinhardt. 1997. "The Record of American Democracy, 1984-1990," Harvard University, Cambridge, MA [producer],
Ann Arbor, MI: ICPSR [distributor].