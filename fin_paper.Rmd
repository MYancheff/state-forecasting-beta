---
title: "Modeling"
output: github_document
---


```{r load_everything, echo=FALSE}
library(foreign)
library(tidyverse)
library(lubridate)
library(rpart)
library(ggthemes)
library(Amelia)
library(mice)
library(data.table)

precinct_data_all = read_csv("Nevada General Election Precinct Level Voting Results 1984-2016.csv")
source("load_carls.R")
source("load_precinct_data.R")
source("load_econ_data.R")
```

```{r district_level_data, echo=FALSE}
pres_summary = precinct_data_all %>% 
  filter(OFFICENAME %in% c("president","governor")) %>%
  filter(!is.na(VOTES)) %>%
  group_by(OFFICENAME,YEAR,STATE_LEGISLATIVE_CHAMBER,DIST_NAME,DISTRICT_NUM,PARTY_CODE) %>%
  summarise(vote_count = sum(VOTES),
            Party = get_pres_gov_party(PARTY_CODE[1])) %>%
  summarise(vote_dem = sum(ifelse(PARTY_CODE=="DEM",vote_count,0)),
            total_vote = sum(vote_count)) %>%
  ungroup() %>%
  gather(key=value_type,value=vote_value,vote_dem:total_vote)%>%
  unite(RaceValue,OFFICENAME,value_type) %>%
  spread(RaceValue,vote_value) %>%
  # deals with werid zeros by remoing them
  mutate(governor_vote_dem = ifelse(governor_vote_dem == 0,NA,governor_vote_dem))
  
  
named_data = pres_summary %>% 
  mutate(DISTRICT_NUM = ifelse(is.na(DISTRICT_NUM),1,DISTRICT_NUM)) %>%
  filter()

joined_named_data = use_data %>%
  left_join(named_data,
            by=c("ELECTION_YEAR"="YEAR","Assembly"="STATE_LEGISLATIVE_CHAMBER","DISTRICT_NUM"="DISTRICT_NUM","DISTRICT_NAME"="DIST_NAME")) %>%
  filter(Assembly == "SENATE" & ELECTION_YEAR < 2012)

unnamed_data = pres_summary %>% 
  select(-DIST_NAME)

joined_unnamed_data = use_data %>%
  left_join(unnamed_data,
            by=c("ELECTION_YEAR"="YEAR","Assembly"="STATE_LEGISLATIVE_CHAMBER","DISTRICT_NUM"="DISTRICT_NUM")) %>%
  filter(!(Assembly == "SENATE" & ELECTION_YEAR < 2012))

district_level_data = rbind(joined_named_data,joined_unnamed_data) %>%
  mutate(party_val = ifelse(wining_party == "DEM",1,
                            ifelse(wining_party == "REP",-1,0)),
         governor_perc_vote_dem = governor_vote_dem/governor_total_vote,
         president_perc_vote_dem =
           president_vote_dem/president_total_vote) %>%
  select(-(governor_total_vote:president_vote_dem))
```

```{r state_level_data,echo=FALSE}
pres_party_in_power_data = read_csv("state-legislative-data/pres_in_power.csv")

state_level_data = economic_data %>%
  left_join(pres_party_in_power_data,by=c("YEAR"="year")) %>%
  
  # spread party_in_power variable over all the years they are in power, not just every 4 years
  group_by((YEAR-1) %/% 4) %>%
  mutate(pres_party_in_power = paste(ifelse(is.na(pres_party_in_power),"",pres_party_in_power),collapse="")) %>%
  ungroup() %>%
  
  #calculate midterm and presidentail election penalties
  mutate(is_midterm = (YEAR %% 4) == 2,
         is_pres_election = (YEAR %% 4) == 0,
         pres_party_num = ifelse(pres_party_in_power=="DEM",1,
                                 ifelse(pres_party_in_power=="REP",-1,0)),
         midterm_penalty = pres_party_num * is_midterm,
         pres_elect_penalty = pres_party_num * is_pres_election) %>%
  
  select(YEAR:Unemployment_LOCAL,midterm_penalty,pres_elect_penalty) %>%
  mutate(lag_MHI_Change_LOCAL = lag(MHI_Change_LOCAL,order_by=YEAR))
```

```{r assembly_level_summary,echo=FALSE}
year_summary = district_level_data %>%
  group_by(Assembly,ELECTION_YEAR) %>%
  summarise(assembly_composition = sum(party_val)/n()) %>%
  mutate(lag_assembly_composition = lag(assembly_composition,order_by=ELECTION_YEAR)) %>%
  ungroup()
```

```{r,echo=FALSE}
joined_district_data = district_level_data %>%
  left_join(year_summary ,by=c("ELECTION_YEAR","Assembly")) %>%
  left_join(state_level_data ,by=c("ELECTION_YEAR"="YEAR")) %>%
  mutate(DIST_ID = factor(paste(DISTRICT_NAME,DISTRICT_NUM))) %>%
  select(-DISTRICT_NUM,-DISTRICT_NAME)
```


```{r,echo=FALSE}
lagged_district_data = joined_district_data %>%
  group_by(Assembly,DIST_ID) %>%
  #lagged by one year entry (i.e. 2 years for house, 4 years for senate)
  mutate(lag_governor_perc_vote_dem = lag(governor_perc_vote_dem,order_by=ELECTION_YEAR),
         lag_president_perc_vote_dem = lag(president_perc_vote_dem,order_by=ELECTION_YEAR),
         lag_assembly_vote_dem = lag(assembly_vote_dem,order_by=ELECTION_YEAR),
         lag_incumbent_factor = lag(incumbent_factor,order_by=ELECTION_YEAR)) %>%
  ungroup()
```

```{r impute_missing,echo=FALSE}
impute_data = function(all_data){
  mice_imputed_data = complete( mice( all_data ,printFlag=FALSE,m=1))
  
  
  # conducts amelia imputation
  #removed_amelia_cols = all_data %>%
  #  select(DIST_ID,Assembly,wining_party,party_val,pres_elect_penalty,has_incumbent,lag_has_incumbent)
  
  #amelia_data = all_data %>%
  #  select(-DIST_ID,-Assembly,-wining_party,-party_val,-pres_elect_penalty,-has_incumbent,-lag_has_incumbent)
  
  #amelia_fit <- amelia(amelia_data,
  #                     m=1,
  #                     p2s=0,#2 is verbose, 1 is not as verbose, 0 is no output
  #                     ts="ELECTION_YEAR")
  #amelia_imputed_data = cbind(amelia_fit$imputations[[1]],removed_amelia_cols)
  
  #check if mice_imputed_data or amelia_imputed_data works better
  
  mice_imputed_data
}
zero_off_election_years = function(data){
  data %>%
  mutate(governor_perc_vote_dem = 
           ifelse(ELECTION_YEAR %% 4 == 2,governor_perc_vote_dem,0),
         president_perc_vote_dem =
           ifelse(ELECTION_YEAR %% 4 == 0,president_perc_vote_dem,0),
         lag_governor_perc_vote_dem = ifelse(ELECTION_YEAR %% 4 == 0,lag_governor_perc_vote_dem,0),
         lag_president_perc_vote_dem = ifelse(ELECTION_YEAR %% 4 == 2,lag_president_perc_vote_dem,0))
}
```


```{r,echo=FALSE}
place_has_incumbent = function(data){
  data %>%
    mutate(has_incumbent = ifelse(incumbent_factor==0,0,1),
           lag_has_incumbent = ifelse(lag_incumbent_factor==0,0,1))
}
linear_model_acc = function(train_data,test_data){
  model = lm(assembly_composition ~ 
       #state level data
       lag_assembly_composition*GDPperCapita_CHANGE_US + 
       MHI_Change_LOCAL +
       lag_MHI_Change_LOCAL +
       GDPperCapita_CHANGE_US + 
       midterm_penalty + 
       pres_elect_penalty + 
        
       # district level variables
       incumbent_factor + 
       lag_incumbent_factor + 
       lag_governor_perc_vote_dem + 
       lag_president_perc_vote_dem + 
       lag_assembly_vote_dem
       ,data=train_data)
  
  guessed_outcome = predict(model,test_data,type = "response")
  actual_outcome = test_data$assembly_composition
  ms_error = sqrt(sum((guessed_outcome-actual_outcome)^2)/nrow(test_data))
  mean((guessed_outcome+1)/2)
}
probit_model_acc = function(train_data,test_data){
  model = glm((party_val+1)/2 ~
       #state level data
       lag_assembly_composition*GDPperCapita_CHANGE_US + 
       MHI_Change_LOCAL +
       lag_MHI_Change_LOCAL +
       GDPperCapita_CHANGE_US + 
       midterm_penalty + 
       pres_elect_penalty + 
        
       # district level variables
       incumbent_factor + 
       lag_incumbent_factor + 
       (lag_governor_perc_vote_dem + 
       lag_president_perc_vote_dem + 
       lag_assembly_vote_dem) * has_incumbent
       ,data=train_data
       ,family="binomial")
  guessed_outcome = predict(model,test_data,type = "response")
  discrete_guessed_outcome = ifelse(guessed_outcome>0.5,1,0)
  actual_outcome = (test_data$party_val+1)/2
  
  miscalc_rate = sum(ifelse(discrete_guessed_outcome != actual_outcome,1,0))/nrow(test_data)
  sum(discrete_guessed_outcome)/nrow(test_data)
}
get_model_accuracy = function(assembly_data,model_acc,testyear){
  train_data = assembly_data %>%
    filter(ELECTION_YEAR < testyear) %>%
    impute_data() %>%
    # needs to happen after imputation or else the imputation is terreble
    zero_off_election_years()
  
  test_data = assembly_data %>%
    impute_data() %>%
    filter(ELECTION_YEAR == testyear) %>%
    zero_off_election_years() 
  
  model_acc(train_data,test_data)
}
testyear = 2014
get_accuracies = function(assembly_data,generate_model_fn){
  years = assembly_data %>%
    select(ELECTION_YEAR) %>%
    distinct()
  estimate_years = years$ELECTION_YEAR[years$ELECTION_YEAR > 1996]
  accuracies = sapply(estimate_years,function(test_year){
    get_model_accuracy(assembly_data,generate_model_fn,test_year)
  })
  possible_elections = sapply(estimate_years,function(test_year){
    nrow(assembly_data %>%
      filter(ELECTION_YEAR == test_year))
  }) 
  data.frame(accuracies,estimate_years,possible_elections)
}
get_assembly_data = function(assembly){
  start_year = 1986
  assembly_data = lagged_district_data %>%
    filter(Assembly==assembly,
           ELECTION_YEAR>=start_year) %>%
    place_has_incumbent()
}
```


```{r,echo=FALSE}

assembly_data = get_assembly_data("HOUSE")

probit_acccs = get_accuracies(assembly_data,probit_model_acc)
linear_acccs = get_accuracies(assembly_data,linear_model_acc)

act_data = year_summary %>%
  filter(ELECTION_YEAR> 1996,
         Assembly=="HOUSE") %>%
  mutate(actual_data = (1+assembly_composition)/2) %>%
  select(ELECTION_YEAR,actual_data)

act_data$linear_fit = linear_acccs$accuracies
act_data$probit_fit = probit_acccs$accuracies

act_data %>%
  gather(key=fit_type,value=senate_comp_value,-ELECTION_YEAR) %>%
  ggplot(aes(x=ELECTION_YEAR,y=senate_comp_value,color=fit_type))+
    geom_line() + 
    scale_y_continuous(limits = c(0,1.7))

```

```{r,echo=FALSE}
num_samples = 8
all_accuracies_house = rbindlist(lapply(1:num_samples,function(n)get_accuracies(get_assembly_data("HOUSE"))))
all_accuracies_senate = rbindlist(lapply(1:num_samples,function(n)get_accuracies(get_assembly_data("SENATE"))))
```

```{r,echo=FALSE}
all_accuracies_house$Assembly="HOUSE"
all_accuracies_senate$Assembly="SENATE"
all_accuracies = rbind(all_accuracies_house,all_accuracies_senate)
ggplot(all_accuracies,aes(x=estimate_years,y=accuracies/possible_elections,color=Assembly)) +
  geom_point() + 
  geom_smooth()
```

Plot showing why we did Nevada.



```{r,echo=FALSE}
na_to_zero = function(val)ifelse(is.na(val),0,val)

y2016_dat = filter(lagged_district_data,ELECTION_YEAR==2016)
lagged_district_data %>%
  mutate(elect_type= ifelse(ELECTION_YEAR %% 4 == 2,"pres","gov"),
         lag_vote_dem = na_to_zero(lag_governor_perc_vote_dem)+na_to_zero(lag_president_perc_vote_dem)) %>%
  filter(#abs(assembly_vote_dem) != 1,
         lag_vote_dem != 0) %>%
  ggplot(aes(y=lag_vote_dem,x=assembly_vote_dem/2+0.5))+
  geom_smooth(method="lm") + 
  geom_point() + 
  ggtitle("Predictive Power of Vote for President in Previous election on State Legislative Vote at the District Level") + 
  ylab("Percent vote for Republican State Legislator") + 
  xlab("Percent vote for Republican President in previous election") + 
  facet_wrap(~elect_type+ELECTION_YEAR)
```

```{r,echo=FALSE}
#Calculate percentage of house captured by Democrats during a Given Year's General Election
percent_seat_data <- tot_data %>%
  group_by(ELECTION_YEAR, Assembly) %>%
  summarize(perc_seats_dem = sum(wining_party=="DEM")/n()) %>%
  left_join(economic_data,by=c("ELECTION_YEAR"="YEAR"))


#Tidy df so that we can graph data on a 2 dimensional plane 
#Exclude unemployment rate (it stretches te y-axis scale too far to capture insights on
# the correlating patterns between voting and economic data)
with_economic_Tidied1 <- percent_seat_data %>% gather(Type,Val,-ELECTION_YEAR, -Assembly, 
                                                      -Unemployment_LOCAL)
#Visualize 
graph1 <- ggplot(with_economic_Tidied1,aes(x=ELECTION_YEAR, y=Val, col=Type)) + 
  geom_line() + 
  facet_wrap(~Assembly)

#Tidy a separate df by gathering just Unemployment_Local  and perc_seats_dem under Type
with_economic_Tidied2 <- percent_seat_data %>% gather(key = Type, value = Percent, 
                                                      Unemployment_LOCAL, perc_seats_dem)
```

# Modeling State Legislative Elections In Nevada

Nevada is a politically volitile state, with the state legislature changing every couple of years recently.

```{r,echo=FALSE,warning=FALSE}
zero_intercept_years = year_summary %>%
  group_by(Assembly) %>%
  mutate(m = (assembly_composition-lag(assembly_composition,order_by=ELECTION_YEAR))/(ELECTION_YEAR-lag(ELECTION_YEAR,order_by=ELECTION_YEAR)),
         b = assembly_composition - m * ELECTION_YEAR,
         x_cross = -b/m) %>%
  filter(x_cross > lag(ELECTION_YEAR,order_by=ELECTION_YEAR) & x_cross < ELECTION_YEAR) %>%
  ungroup() %>%
  mutate(ELECTION_YEAR=x_cross,
         assembly_composition=0) %>%
  select(ELECTION_YEAR,assembly_composition,Assembly)

plot_chart_use_data = year_summary %>%
  select(-lag_assembly_composition) %>%
  rbind(zero_intercept_years) %>%
  arrange(ELECTION_YEAR)

argvar = data.frame(YEAR=c(min(plot_chart_use_data$ELECTION_YEAR),max(plot_chart_use_data$ELECTION_YEAR)),party_composition=c(0.5,0.5))

plot_chart_use_data %>%
  mutate(assembly_composition = assembly_composition*0.5 + 0.5,
         dem_years = assembly_composition,
         rep_years = 1-assembly_composition) %>%
  gather(dem_years,rep_years,key=party_year,value=party_composition) %>%
  ggplot(aes(x=ELECTION_YEAR,y=party_composition,fill=party_year)) + 
    geom_area(position="stack") + 
    facet_grid(~Assembly) + 
    geom_line(data=argvar,mapping=aes(x=YEAR,y=party_composition,fill=NA),color="black") + 
    theme_few() + 
    xlab("Year") + 
    ylab("Party control of assembly") + 
    ggtitle("Nevada State Legislature Party Composition over Time") + 
    scale_fill_manual(values=c("blue","red"),
                      labels=c("Democratic","Republican"),
                      guide = guide_legend(title = "Party"))
    
```

We want to model state legislative elections, so that we can predict future election results. In particular, the most important result people usually want to know is the party composition of the state legislatures, as this can determine the policy agenda for the state. 

Unfortunately, forecasting state legislative elections is difficult. There is a lot of unobserved characteristics especially at the district level, with certain candidates being of better qualities than others, or particular features of the districts at hand. 

Unfortunatly, in Nevada there has been a lot of redistricting, and a lack of precinct level maps that would allow us to account for this by performing a geographic join. Without those maps, we cannot account for unobserved variables in districts by tracking them over a long period of time. 

So we need to gather as much information about a district as possible. For example, one clearly useful variable is the extent to which the canidate of the Democratic party won in the prior year. Another one is whether that canidate was an incumbent or not, and whether they are running again in the upcoming election.

We also gathered several variables at the state and national level, including economic variables such as GDP and median household income, several policial variables such as the party of the president, and governor, and the state legislative composition in the previous year.


### Data Tidying and Joining

The format of the tidied dataset we want to model is this:

Every row is a (Year, Assembly, District) triple. This is a nice unit because it is the unit we want to run models on. However, none of our data is in this form. All of our data is in a (Year, Canidate) format. So in each dataset, before joining, we need to summarize the sort of covariates we want from that bit of candidate level data.






